<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHACL Form Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-container {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .form-container h2 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .buttons {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    <!-- XLSX library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
</head>
<body>
    <div id="forms"></div>

    <div class="buttons">
        <button id="submitButton">Submit Form</button>
        <button id="exportButton">Export Completed Form</button>
        <button id="exportExcelButton">Export Table to Excel</button>
    </div>

    <input type="file" id="fileInput" accept=".jsonld" />
    <input type="file" id="formFileInput" accept=".json" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/1.8.1/jsonld.min.js"></script>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        let currentFormData = {};
        let expandedShapes = [];
        let allFields = [];

        Office.onReady(function (info) {
            if (info.host === Office.HostType.Excel) {
                Excel.run(function (context) {
                    var sheet = context.workbook.worksheets.getActiveWorksheet();
                    sheet.onSelectionChanged.add(handleSelectionChange);
                    return context.sync();
                }).catch(function (error) {
                    console.error(error);
                });
            }
        });

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
            document.getElementById('formFileInput').addEventListener('change', handleFormFileSelect, false);
            document.getElementById('submitButton').addEventListener('click', submitForm, false);
            document.getElementById('exportButton').addEventListener('click', exportForm, false);
            document.getElementById('exportExcelButton').addEventListener('click', exportTableToExcel, false);
        });

        function handleSelectionChange(event) {
            Excel.run(function (context) {
                var sheet = context.workbook.worksheets.getActiveWorksheet();
                var selectedRange = sheet.getRange(event.address);
                selectedRange.load(["address", "rowCount", "columnCount", "values"]);
                return context.sync().then(function () {
                    var rowNumber = selectedRange.address.match(/\d+/)[0];
                    
                    if (selectedRange.address.match(/^X/)) {
                        var columnXCell = sheet.getRange("X" + rowNumber);
                        var columnMCell = sheet.getRange("M" + rowNumber);
                        columnXCell.load("values");
                        columnMCell.load("values");

                        return context.sync().then(function () {
                            var shapeId = columnMCell.values[0][0];

                            if (!columnXCell.values[0][0] && shapeId) {
                                var newJsonObject = createNewJsonObject(shapeId);
                                columnXCell.values = [[JSON.stringify(newJsonObject)]];
                                return context.sync();
                            }
                        });
                    }
                });
            }).catch(function (error) {
                console.error(error);
            });
        }

        function createNewJsonObject(shapeId) {
            let newJsonObject = {
                "@type": "",
                "properties": {}
            };

            const matchingShape = expandedShapes.find(shape => shape['@id'] === `http://www.toronto.ca/TWONTO#${shapeId}_defaultShape`);

            if (matchingShape) {
                newJsonObject["@type"] = matchingShape['@id'];
                newJsonObject["properties"] = {};

                const properties = matchingShape['http://www.w3.org/ns/shacl#property'];
                if (properties) {
                    properties.forEach(propertyRef => {
                        const property = allFields.find(node => node['@id'] === propertyRef['@id']);
                        if (property) {
                            const path = property['http://www.w3.org/ns/shacl#path']?.[0]?.['@id'] || '';
                            const defaultValue = getDefaultPropertyValue(property);
                            newJsonObject["properties"][path] = defaultValue;
                        }
                    });
                }
            } else {
                console.warn(`No matching shape found for shapeId: ${shapeId}`);
            }

            return newJsonObject;
        }

        function getDefaultPropertyValue(property) {
            const dataType = property['http://www.w3.org/ns/shacl#datatype']?.[0]?.['@id'];
            let defaultValue = "default_value";

            if (dataType === "http://www.w3.org/2001/XMLSchema#integer") {
                defaultValue = 0;
            } else if (dataType === "http://www.w3.org/2001/XMLSchema#decimal") {
                defaultValue = 0.0;
            } else if (dataType === "http://www.w3.org/2001/XMLSchema#string") {
                defaultValue = "";
            }

            return defaultValue;
        }

        function writeData(data) {
            Excel.run(function (context) {
                var sheet = context.workbook.worksheets.getActiveWorksheet();
                var cell = context.workbook.getSelectedRange();
                cell.values = [[JSON.stringify(data)]];
                return context.sync();
            }).catch(function (error) {
                console.error(error);
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const jsonldContent = JSON.parse(event.target.result);
                parseSHACL(jsonldContent);
            };
            reader.readAsText(file);
        }

        function parseSHACL(jsonldContent) {
            jsonld.expand(jsonldContent, (err, expanded) => {
                if (err) {
                    console.error(err);
                    return;
                }
                allFields = expanded;
                expandedShapes = expanded.filter(node => node['@type'] && node['@type'].includes('http://www.w3.org/ns/shacl#NodeShape'));
            });
        }

        function handleFormFileSelect(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                currentFormData = JSON.parse(event.target.result);
                populateForm(currentFormData);
            };
            reader.readAsText(file);
        }

        function populateForm(data) {
            for (const key in data) {
                const element = document.getElementById(key);
                if (element) {
                    element.value = data[key];
                    const event = new Event('change', { bubbles: true });
                    element.dispatchEvent(event);
                }
            }
        }

        function exportForm() {
            const forms = document.querySelectorAll('.form-container');
            let formData = {};

            forms.forEach(form => {
                const inputs = form.querySelectorAll('input, select');
                inputs.forEach(input => {
                    formData[input.name] = input.value;
                });
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(formData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "form_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        async function submitForm() {
            const forms = document.querySelectorAll('.form-container');
            let formData = {};

            forms.forEach(form => {
                const inputs = form.querySelectorAll('input, select');
                inputs.forEach(input => {
                    formData[input.name] = input.value;
                });
            });

            try {
                writeData(formData);
            } catch (error) {
                console.error('Error adding document: ', error);
            }
        }

        function exportTableToExcel() {
            const table = document.getElementById('submissionsTable');
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, 'submissions.xlsx');
        }
    </script>
</body>
</html>
